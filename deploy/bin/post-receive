#!/usr/bin/env bash
set -eoux pipefail

user=$(whoami)
kernel=$(uname)
dir="/home/${user}/deploy/app"
app=$(basename $(pwd) | sed -e 's/.git//')
deploy_dir="$dir/$app"
cron_dir="/etc/cron.d"

GIT_WORK_TREE="$deploy_dir" git checkout -f

cd "$deploy_dir"

## build steps here ###
case "$kernel" in
  (Linux)
    case "$user" in
      (skilbjo) sudo cp deploy/tasks/crontab "$cron_dir/$app" ;;
      (pi) sudo cp deploy/tasks/crontab-rspi "$cron_dir/$app" ;;
    esac ;;
  (FreeBSD)
    sudo cp deploy/tasks/freebsd "/var/cron/tabs/$app" ;;
esac

## start
source ~/.profilelocal
case "$kernel" in
  (Linux)
    deploy/bin/marathon ;;
  (FreeBSD)
    deploy/bin/marathon-udoo ;;
esac

echo "all done"

exit 0
