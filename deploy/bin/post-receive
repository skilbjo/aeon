#!/usr/bin/env bash
set -eoux pipefail

user=$(whoami)
dir="/home/${user}/deploy/app"
app=$(basename $(pwd) | sed -e 's/.git//')
deploy_dir="$dir/$app"
cron_dir="/etc/cron.d"

GIT_WORK_TREE="$deploy_dir" git checkout -f

cd "$deploy_dir"

## build steps here ##
docker ps -a | grep compojure | awk '{print $1}' | xargs docker rm -f
docker images | grep compojure | awk '{print $3}' | grep -v IMAGE | xargs docker rmi --force

## start
~/deploy/app/compojure/deploy/bin/run-docker &

echo "all done"

exit 0
